---
title: "Model evaluation"
author: "Gauri Priya Saran"
date: "31/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggplot2)
library(EpiNow2)
library(stringr)
library(purrr)
library(lubridate)
library(plotly)
library(RColorBrewer)
library(zoo)

source("../R/open_ottawa_scripts.R")
source("../R/wastewater.R")
source("../R/epinow_functions.R")
```

# Load data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# load data
ott_covid_data <- read.csv(file.path(getwd(), "../Data/Observed data/OPH_Observed_COVID_Data.csv"))

ww_data <-
  read.csv("https://raw.githubusercontent.com/Big-Life-Lab/PHESD/main/Wastewater/Ottawa/Data/wastewater_virus.csv")

# prep ww data
ww_clean <- wastewater_prep(ww_data) %>%
  select(date, N1_N2_avg, N1_N2_avg_clean) %>%
  mutate(date = as.Date(date))
```

# Loading Case projection Data 
```{r, echo=FALSE, warning=FALSE, message=FALSE}
load("jul20_present22_cases_proj.RData")
```

# Current growth estimates for observed new case data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
estimates_cases = cases_forecast_jul20_pres22[[2]]
print(estimates_cases)
```

# Plot of case projection data for Rt
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualizing projections
short_term_plot(
  projections = cases_forecast_jul20_pres22[[1]], # projection data
  obs_data = ott_covid_data, # observed data
  obs_column = "observed_new_cases", # observed data column
  forecast_type = "R", # forecast type
  ylab = "Effective Reproduction # Rt", # yaxis label
  title = "Projections of Rt for observed new cases" # plot title
)
```


# Plot of case projection data over time

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualizing projections
short_term_plot(
  projections = cases_forecast_jul20_pres22[[1]], # projection data
  obs_data = ott_covid_data, # observed data
  obs_column = "observed_new_cases", # observed data column
  forecast_type = "reported_cases", # forecast type
  ylab = "Number of Infections", # yaxis label
  title = "Projections of Cases over time" # plot title
)
```


# Load the hospital case data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
load("jul20_present22_hosp_proj.RData")
```

# Current growth rate estimates for hospital census data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
estimates_hosp_cases = hosp_forecast_jul_pres[[2]]
print(estimates_hosp_cases)
```


# Plot of hospital case data for Rt projection

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualizing projections
short_term_plot(
  projections = hosp_forecast_jul_pres[[1]], # projection data
  obs_data = ott_covid_data, # observed data
  obs_column = "observed_census_ICU_p_acute_care", # observed data column
  forecast_type = "R", # forecast type
  ylab = "Effective Reproduction #", # yaxis label
  title = "Projections of Rt for hospital case data" # plot title
)
```

#Plot of Hospital cases over time

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualizing projections
short_term_plot(
  projections = hosp_forecast_jul_pres[[1]], # projection data
  obs_data = ott_covid_data, # observed data
  obs_column = "observed_census_ICU_p_acute_care", # observed data column
  forecast_type = "reported_cases", # forecast type
  ylab = "Hospital cases over time", # yaxis label
  title = "Projections of Hospital cases over time" # plot title
)
```

# Load the waste water data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
load("jul20_present22_ww_proj.RData")
```


# Current growth estimates of waste water data
```{r, echo=FALSE, warning=FALSE, message=FALSE}
estimates_ww_data = ww_forecast_jul_pres[[2]]
print(estimates_ww_data)
```



# Plot of waste water data for Rt projection
```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualizing projections
short_term_plot(
  projections = ww_forecast_jul_pres[[1]], # projection data
  obs_data = ww_clean, # observed data
  obs_column = "N1_N2_avg_clean", # observed data column
  forecast_type = "R", # forecast type
  ylab = "Effective Reproduction #", # yaxis label
  title = "Projections of Rt for waste water data" # plot title
)
```

# Plot of waste water data for viral signal over time

```{r, echo=FALSE, warning=FALSE, message=FALSE}
ww_normalized <- ww_clean %>%
  mutate(N1_N2_avg_clean = N1_N2_avg_clean*1000000)

# Visualizing projections
short_term_plot(
  projections = ww_forecast_jul_pres[[1]], # projection data
  obs_data = ww_normalized, # observed data
  obs_column = "N1_N2_avg_clean", # observed data column
  forecast_type = "reported_cases", # forecast type
  ylab = "Viral signal over time (Âµ)", # yaxis label
  title = "Projections of viral signal over time" # plot title
)
```