---
title: "EpiNow2 tutorial"
author: "Warsame Yusuf"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Load the necessary packages
library(tidyverse)
library(ggplot2)
library(EpiNow2)
library(stringr)
library(purrr)
library(lubridate)
library(plotly)
library(RColorBrewer)
library(zoo)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Source the necessary R files containing the functions of interest
source("../R/epinow_functions.R")
source("../R/wastewater.R")
source("../R/observed_data.R")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Load case/hospitalizations dataset
ott_covid_data <- read.csv(file.path(getwd(), "../../Data/Observed data/OPH_Observed_COVID_Data.csv"))

# Load wastewater dataset
ww_data <- read.csv("https://raw.githubusercontent.com/Big-Life-Lab/PHESD/main/Wastewater/Ottawa/Data/wastewater_virus.csv")
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Prepare WW data for projections
ww_clean <- wastewater_prep(ww_data) %>% # function cleans and organizes WW data
  select(date, N1_N2_avg_clean) %>% # select columns from cleaned dataset
  mutate(date = as.Date(date)) # ensure date column is in date class
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Running short term projections
ott_short_forecast <- short_term_forecast(
  data = ott_covid_data,
  parameter = "observed_new_cases",
  start_date = "2021-12-01", # can be changed
 # end_date = "2020-11-24", # can be changed, if missing will default to last day
  omit_last_date = TRUE,
  generation_time = generation_time,
  incubation_period = incubation_period,
  reporting_delay = reporting_delay,
  output = "both"
)

ott_projections <- ott_short_forecast[[1]]
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
short_term_plot(
  projections = ott_projections,
  obs_data = ott_covid_data,
  obs_column = "N1_N2_avg_clean",
  forecast_type = "observed_new_cases",
  ylab = "New cases",
  title = "Projections for new cases"
)
```