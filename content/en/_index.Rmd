---
title: "Ottawa COVID-19 Projections"
params:
  lang: en
output:
  html_document: default
  pdf_document: default
  word_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
lang <- params$lang
```

```{r include=FALSE}
##Load localization file
source("../../R/localization.R")
localization_data <- read.csv(file.path(getwd(),"../../Data/translations/Covid Localization - Home Page.csv"))
```

```{r, results='hold', echo=FALSE, comment=NA}
time <- .POSIXct(Sys.time(), "America/New_York")
intro<- insert_translation(localization_data, lang, "Intro", c(format(time, '%d %B, %Y, %X')))
dt_label_half <- insert_translation(localization_data, lang, "DT_label_half")
dt_label_double <- insert_translation(localization_data, lang, "DT_label_double")
dt_label_no_change <- insert_translation(localization_data, lang, "DT_label_no_change")
more <- insert_translation(localization_data, lang, "more")
fewer <- insert_translation(localization_data, lang, "fewer")
the_same <- insert_translation(localization_data, lang, "the_same")

numofweeks <- "twoweek"
site <- "CovidEmployeeData"
```

`r intro`
```{r echo=FALSE, message=FALSE, warning=FALSE}

# libraries
library(rmarkdown)
library(plotly)
library(tidyverse)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(stats)
library(zoo)
library(EpiNow2)
library(stringr)
library(purrr)
library(readxl)
library(RColorBrewer)

# scripts
source("../../R/lag_replacement.R")
source("../../R/observed_data.R")
source("../../R/open_ottawa_scripts.R")
source("../../R/epinow_functions.R")

# Loading the covid data of the health care workers in Ottawa (rate of Covid cases per 1000 population)


load("../../Data/Observed data/cumulative_data_absenteeism.RData")

#covid_data <- covid_data %>% rename(date = sampleDate)


# data
ott_observed <- read.csv(file.path(getwd(), "../../Data/Observed data/OPH_Observed_COVID_Data.csv"))

ott_observed_staff <- ott_observed %>% mutate(date = as.Date(date)) %>% full_join(covid_data, by= "date")


site = "Covid Employee Data"
#Loading health care worker staff two week Covid projections per 1000 population
load(paste0("../../Data/Historic Projections/rate_transformed_historic_cases_projections_twoweek", gsub(" ", "", site), ".RData"))


load(paste0("../../Data/Historic Projections/historic_cases_summary_stats_twoweek", gsub(" ", "", site), ".RData"))

## summary estimates below
summary_estimates <- cases_forecast[[2]]

## summary statistics below:
summary_stats <- cases_forecast[[3]]

## Variable type == "R"
staff_cov_projections_3 <- cases_forecast[[1]] %>% filter(variable == "R") 

load("../../Data/short_term_forecast.RData")
load("../../Data/short_term_hosp_proj.RData")
ott_projections <- ott_short_forecast[[1]]


## Observed census
exp_census <- calc_expected_values_for_n_weeks(data = ott_observed, number_weeks = 3, first_day = 1)

## Dt = doubling (or halving) time
Dt_census <- exp_census[[2]][[3]]

diff_census <- (last(na.omit(exp_census[[3]][[3]][[1]])) -
           first(na.omit(exp_census[[3]][[3]][[1]])))/first(na.omit(exp_census[[3]][[3]][[1]]))

if(is.na(diff_census)){
  diff_census <- 0
}

if(abs(diff_census) <= 0.05){
  Dt_census <- 0
}

if(Dt_census == Inf) {
  Dt_census <- 0
}

Dt_label_census = switch( 
  (sign(Dt_census) + 2),
  dt_label_half,
  dt_label_no_change,
  dt_label_double)

more_less_census = switch(
  (sign(Dt_census) + 2),
  fewer,
  the_same,
  more
)

dt <- summary_stats[[5]][[1]]
dt_label = switch( 
  (sign(dt) + 2),
  "Case halving time:",
  "No change:",
  "Case doubling time:")

dt_abs <- abs(dt)

dt_sts <- summary_stats[[3]][[1]]
dt_label_sts = "Rt:"


dt_sts_abs <- abs(dt_sts)

## Observed new cases by episode date (excluding past 7 days)
ott_observed_episodes <- as.data.frame(ott_observed[1:(nrow(ott_observed) - 6),])

exp_new_episodes <- calc_expected_values_for_n_weeks(data = ott_observed_episodes,
                                                     number_weeks = 3,
                                                     observed_columns_name = "observed_new_episodes",
                                                     first_day = 1)

diff_new_episodes <- (last(na.omit(exp_new_episodes[[3]][[3]][[1]])) -
           first(na.omit(exp_new_episodes[[3]][[3]][[1]])))/first(na.omit(exp_new_episodes[[3]][[3]][[1]]))

if(abs(diff_new_episodes) <= 0.05){
  Dt_new_episodes <- 0
}

## Dt = doubling (or halving) time
Dt_new_episodes <- exp_new_episodes[[2]][[3]]

if(Dt_new_episodes == Inf) {
  Dt_active_cases <- 0
}

Dt_label_new_episodes = switch( 
  (sign(Dt_new_episodes) + 2),
  dt_label_half,
  dt_label_no_change,
  dt_label_double)

more_less_new_episodes = switch(
  (sign(Dt_new_episodes) + 2),
  fewer,
  the_same,
  more
)


## Observed active cases
exp_active_cases <- calc_expected_values_for_n_weeks(data = ott_observed,
                                                     number_weeks = 3,
                                                     observed_columns_name = "observed_active_cases",
                                                     first_day = 1)

diff_active_cases <- (last(na.omit(exp_active_cases[[3]][[3]][[1]])) -
           first(na.omit(exp_active_cases[[3]][[3]][[1]])))/first(na.omit(exp_active_cases[[3]][[3]][[1]]))

if(abs(diff_active_cases) <= 0.05){
  Dt_active_cases <- 0
}

## Dt = doubling (or halving) time
Dt_active_cases <- exp_active_cases[[2]][[3]]

if(Dt_active_cases == Inf) {
  Dt_active_cases <- 0
}

Dt_label_active_cases = switch( 
  (sign(Dt_active_cases) + 2),
  dt_label_half,
  dt_label_no_change,
  dt_label_double)

more_less_active_cases = switch(
  (sign(Dt_active_cases) + 2),
  fewer,
  the_same,
  more
)


# Colors
acute_col <- "rgb(72, 137, 194)"
acute_shade <- "rgba(72, 137, 194, 0.3)"
acute_hex <- "#488AC2"

vent_col <- "rgb(23, 63, 95)"
vent_shade <- "rgba(23, 63, 95, 0.3)"

icu_col <- "rgb(60, 174, 163)"
icu_shade <- "rgba(60, 174, 163)"

current_case_col <- "rgb(0, 128, 128)"
current_case_shade <- "rgba(0, 128, 128)"
current_case_hex <- "#008080"

increase_col <- "rgb(246, 213, 86)"
increase_shade <- "rgba(246, 213, 86)"
increase_hex <- "#F6D556"

reduction_col <- "rgb(133, 194, 43)"
reduction_shade <- "rgba(133, 194, 43)"
reduction_hex <- "#85c22b"

rolling_avg_col <- "rgb(226, 127, 88)"
```

```{r, results='hold', echo=FALSE, comment=NA}
line_break <- insert_translation(localization_data, lang, "break")


dashboard_HCWcovid <- insert_translation(localization_data, lang, "Dashboard_HCWcovid",
                                c(as.character(tail(covid_data$date, n=1)),
                                  dt_label,
                                  dt_abs,
                                  dt_label_sts,
                                  dt_sts_abs,
                                  #last(na.omit(ott_observed$observed_active_cases)),
                                  last(na.omit(ott_observed$observed_census_ICU_p_acute_care)),
                                  last(na.omit(ott_observed$observed_census_acute_care)),
                                  last(na.omit(ott_observed$observed_census_ICU))))

definitions <- insert_translation(localization_data, lang, "Definitions")

short_range_forecast <- insert_translation(localization_data, lang, "ShortRangeForecast", 
                                           c(more_less_active_cases,
                                             Dt_label_active_cases,
                                             round(abs(exp_active_cases[[2]][[3]]), 0),
                                             round(100*exp_active_cases[[4]][[3]], 0),
                                             more_less_new_episodes,
                                             Dt_label_new_episodes,
                                             round(abs(exp_new_episodes[[2]][[3]]), 0),
                                             round(100*exp_new_episodes[[4]][[3]], 0),
                                             more_less_census,
                                             Dt_label_census,
                                             round(abs(exp_census[[2]][[3]]), 0),
                                             round(100*exp_census[[4]][[3]], 0)))

defintions <- insert_translation(localization_data, lang, "Definitions")

def_link <- insert_translation(localization_data, lang, "definitions_link")

past_data_title <- insert_translation(localization_data, lang, "PastData_title") 

past_hospital_text <- insert_translation(localization_data, lang, "PastHospital_text",
                                         c(Dt_label,
                                           round(abs(exp_census[[2]][[3]]), 0),
                                           round(effective_pd, 0))) 

observed_cases <- insert_translation(localization_data, lang, "observed_cases")


#observed_staff <- insert_translation(localization_data, lang, "observed_staff")

observed_cases_text <- insert_translation(localization_data, lang, "observed_cases_text")

observed_staff_cases <- insert_translation(localization_data, lang, "observed_staff_cases")

observed_staff_cases_text <- insert_translation(localization_data, lang, "observed_staff_cases_text")

#observed_incident <- insert_translation(localization_data, lang, "observed_incident")

observed_staff_incident <- insert_translation(localization_data, lang, "observed_staff_incident")

observed_staff_incident_cases_text <- insert_translation(localization_data, lang, "observed_staff_incident_cases_text")

observed_census <- insert_translation(localization_data, lang, "observed_census")

observed_admits <- insert_translation(localization_data, lang, "observed_admits")

projected_hospital_title <- insert_translation(localization_data, lang, "ProjectedHospital_title")

case_projections <- insert_translation(localization_data, lang, "case_projections")

case_projections_text <- insert_translation(localization_data, lang, "case_projections_text",
                                            c(max(ott_projections$date, na.rm = TRUE)))

hosp_projections_text <- insert_translation(localization_data, lang, "hosp_projections_text",
                                            c(max(ott_projections$date, na.rm = TRUE)))

staff_projections <- insert_translation(localization_data, lang, "staff_projections")

staff_projections_text <- insert_translation(localization_data, lang, "staff_projections_text")

staff_rt_projections <- insert_translation(localization_data, lang, "staff_rt_projections")

hosp_projections <- insert_translation(localization_data, lang, "hosp_projections")




```

`r dashboard_HCWcovid`

`r past_data_title`

`r observed_cases`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualize current daily cases
source("../../R/observed_data.R")
observed_new_episodes <- list(type = "observed_data", y_column = "observed_new_episodes", name = "New cases by episode date", color = current_case_hex)
constrain_val = as.Date(last(ott_observed$date)) - as.Date(first(ott_observed$date))
constrain_val = day(days(constrain_val))
reworked_figure(
    xaxis = "date",
    yaxis = list(observed_new_episodes),
    titles = c(y = "Daily cases", x = "Date", title = "Observed daily COVID-19 cases in Ottawa by episode date", ticklabels = "%b %y"),
    data = ott_observed, date_constraint = TRUE, constraint_val =  constrain_val
  )
```

`r observed_cases_text`

`r line_break`

`r observed_staff_cases`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Visualize current daily cases
source("../../R/observed_data.R")
observed_new_episodes <- list(type = "observed_data", y_column = "covidPosAbs_pop", name = "Health care worker cases by episode date", color = current_case_hex)

reworked_figure(
    xaxis = "date",
    yaxis = list(observed_new_episodes),
    titles = c(y = "Health care worker cases (per 1000 people)", x = "Date", title = "Observed COVID-19 cases in health care workers in Ottawa by episode date", ticklabels = "%b %y"),
    data = ott_observed_staff, date_constraint = TRUE, constraint_val = constrain_val
  )
```

`r observed_staff_cases_text`

`r line_break`

`r observed_census`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# Graph selection list
icu_call <- list(type = "observed_data", y_column = "observed_census_ICU", name = "ICU census", color = icu_col)
acute_care <- list(type = "observed_data", y_column = "observed_census_acute_care", name = "Acute care census", color = acute_col)

# Plotly creation 
ottawa_hosp <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(icu_call, acute_care), #DT1, DT2, DT3),
    titles = c(y = "# of patients", x = "Date", title = "Observed count of COVID-19 patients in Ottawa hospitals"),
    data = exp_census[[1]]
  )

# Display graph
ottawa_hosp
```

`r past_hospital_text`

`r line_break`

`r observed_admits`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
observed_daily_ICU_p_acute_care <- list(type = "observed_data", y_column = "observed_new_ICU_p_acute_care", name = "Reported number of patients", color = acute_col)



ICU_p_acute_care <-
  reworked_figure(
    xaxis = "date",
    yaxis = list(observed_daily_ICU_p_acute_care),
    titles = c(y = "# of patients", x = "Date", title = "Observed new COVID-19 hospitalizations in Ottawa"),
    data = ott_observed
  )

ICU_p_acute_care
```

`r line_break`

`r hosp_projections`
`r hosp_projections_text`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# visualize epinow forecast
#short_term_plot(projections = ott_projections, obs_data = ott_observed, obs_column = "observed_new_cases", forecast_type = "reported_cases", ylab = "New cases", title = "Short-term daily COVID-19 cases in Ottawa by reported date")
```


```{r, echo=FALSE, warning=FALSE, message=FALSE}
# visualize epinow forecast
interval_num <- tail(as.Date(hosp_proj$date), 2)[[1]] - as.Date("2021-12-01")
short_term_plot(projections = hosp_proj, obs_data = ott_observed, obs_column = "observed_census_ICU_p_acute_care", forecast_type = "reported_cases", ylab = "Hospital census", title = "Projection of hospital census in Ottawa", tick_labels_date = "%b %y", tick_period = "1 month", interval_num = interval_num)
```


`r line_break`

`r staff_projections`

`r line_break`

`r staff_projections_text`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
# visualize epinow forecast
short_term_plot(projections = staff_cov_projections_2, obs_data = covid_data, obs_column = "covidPosAbs_pop", forecast_type = "reported_cases", ylab = "Health care worker cases (per 1000 people)", title = "Projection of COVID-19 positive health care workers in Ottawa", tick_labels_date = "%b %y", tick_period = "1 month", interval_num = interval_num)
```

`r line_break`

`r staff_rt_projections`

```{r, echo=FALSE, warning=FALSE, message=FALSE}
source("../../R/epinow_functions.R")
# visualize epinow forecast
short_term_plot(projections = staff_cov_projections_3, obs_data = covid_data, obs_column = "covidPosAbs_pop", forecast_type = "R", ylab = "Rt of Health care worker cases (per 1000 people)", title = "Rt Projection of COVID-19 positive health care workers in Ottawa", tick_labels_date = "%b %y", tick_period = "1 month", interval_num = interval_num)
```

`r def_link`

`r definitions`